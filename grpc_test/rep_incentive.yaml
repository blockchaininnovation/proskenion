- set:
    - height
    - valued:
        - variable: top
        - int64
        - height
- set: # height % 8 を取得、8回で周期的
    - ind
    - cast:
        - int32
        - mod:
            - variable: height
            - 8ll
- if: # 一周したら
    - eq:
        - variable: ind
        - 0
    - set: # creator 間の信頼有効辺情報をとってくる
      - edges
      - query:
          authorizer: root@root
          select: "*"
          type: List
          from: creator/follow
          limit: 100
    - set: # ranks = pageranks(edges)
      - ranks
      - pagerank:
          storages:
            variable: edges
          key: "key"
          out: "rank"
    - set: # update_storage command 列を生成
        - cmds
        - list_comp:
            var: rank
            list: ranks
            element:
              update_storage:
                authorizer: root@root
                storage_id:
                  valued:
                    - variable: rank
                    - address
                    - id
                storages:
                  variable: rank
    - set: # account id list を取得
        - acids
        - query:
            authorizer: root@root
            select: id
            type: List
            from: creator/rank
            order_by:
              - rank
              - DESC
            limit: 4
    - set: # acs = List()
        - acs
        - list: nil
    - each: # acs = List{acid[0], acid[1],...}
        - variable: acids
        - acid
        - set:
            - acs
            - concat:
                - variable: acs
                - query:
                    authorizer: root@root
                    select: "*"
                    type: Account
                    from:
                      variable: acid
    - set: # degreaders に保存
        - add_degrade
        - update_object:
            authorizer_id: root@root
            wallet_id: root@root/degraders
            key: acs
            object:
              variable: acs
    - return: # degreaders[0] に 報酬 + 10000
        transaction:
          commands:
            - variable: add_degrade
            - add_balance:
                authorizer_id: root@root
                account_id:
                  valued:
                    - indexed:
                        - variable: acs
                        - account
                        - 0
                    - address
                    - id
                balance: 10000ll
- else:
    - set:
        - acs
        - query:
            authorizer: root@root
            select: acs
            type: List
            from: root@root/degraders
    - return: # degreaders[i%4] に 報酬 + 10000
        transaction:
          commands:
            - add_balance:
                authorizer_id: root@root
                target_id:
                  valued:
                    - indexed:
                        - variable: acs
                        - account
                        - mod:
                            - variable: ind
                            - 4
                    - address
                    - id
                balance: 10000ll